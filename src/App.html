<style>
    @import url("../node_modules/bootstrap/dist/css/bootstrap.min.css");
    @import url("../node_modules/bootstrap/dist/css/bootstrap-reboot.min.css");
</style>

<header>
<h2>TapTap</h2>
</header>


<div class="container">

    <div class="row">

        <div class="col-sm">
            {#each Object.entries(taps) as [name, tap]}
                <Tap
                    name="{name}"
                    tap="{tap}"
					selectedTap="{selectedTap}"
                    on:addToTap="showCatalogue(event.name)"
                    on:clearTap="clearTap(event.name)"
                    on:close="closeTap(event.name)"
                    on:deleteTapEntry="deleteTapEntry(event)"
                    />
            {/each}

            <div class="input-group input-group-sm mb-3">
                <input
                    type="text"
                    class="form-control"
                    placeholder="guest name"
                    aria-label="New Tap"
                    aria-describedby="button-addon2"
                    bind:value="newTapName">
                <div class="input-group-append">
                    <button class="btn btn-sm btn-success" on:click="addTap()">+</button>
                </div>
            </div>

        </div>

        <div class="col-sm">
        {#if selectedTap}

        <Catalogue
            catalogue="{catalogue}"
            on:selectProduct="addToTap(event.product)"
            on:addToCatalogue="addToCatalogue()"
            on:close="unselectTap()"
            bind:newCatalogueItem="newCatalogueItem"
            />

        <span class="badge badge-success"> {selectedTap} </span>
        {/if}
        </div>
    </div>

    </div>
    <footer class="footer">
    <div class="row">
        <div class="col-sm">
            <button class="btn btn-danger" on:click="resetAll()">RESET</button>
        </div>
    </div>
    </footer>

<script>
    import { splice } from 'svelte-extras';
    import Tap from "./Tap.html";
    import Catalogue from './Catalogue.html';
    export default {
        components: { Catalogue, Tap },

        oncreate() {
            const stored = JSON.parse(localStorage.getItem('taptap'));
            console.info('oncreate', {stored});
            this.set(stored);
        },

        onupdate: ({current}) => {
            const {catalogue, taps} = current;
            console.debug('onupdate', catalogue);
            localStorage.setItem('taptap', JSON.stringify(current));
        },

        methods: {
            splice,
            showCatalogue(name) {
                console.debug(`showing catalogue for ${name}`)
                this.set({ selectedTap: name })
            },

            unselectTap() {
                this.set({ selectedTap: null });
            },

            addTap() {
                const { taps, newTapName } = this.get();

                console.debug(`adding tap ${newTapName}`);

                if (Object.keys(taps).indexOf(newTapName) >= 0) {
                    console.warn(`can't add ${newTapName} again`);
                    return
                }

                const update = {};
                update[newTapName] = [];

                this.set({
                    taps: {
                        ...taps,
                        ...update
                    }
                })
            },

            addToTap(product) {
                console.debug("addToTap", {product})
                const { taps, selectedTap } = this.get();
                if (selectedTap) {
                    const update = {};
                    update[selectedTap] = taps[selectedTap].concat(product);

                    this.set({
                        taps: {
                            ...taps,
                            ...update
                        }
                    })
                }
			},

            deleteTapEntry({ name, idx }) {
            },

            clearTap(name) {
				console.debug({ name })
		        const { taps, selectedTap } = this.get();
				const update = {};
				update[name] = taps[name] = []

				this.set({
					taps: {
						...taps,
						...update
					}
				})
            },

            closeTap(name) {
				console.debug({ name })
		        const { taps, selectedTap } = this.get();
				const update = {...taps};
				delete update[name];

				this.set({
					taps: update
				})
			},

			addToCatalogue() {
				const { newCatalogueItem, catalogue } = this.get();
				const { name, price } = newCatalogueItem;

				console.table(catalogue)
				console.table({newCatalogueItem})
				try {
					const parsedPrice = Number.parseFloat(price);
					if (typeof name === 'string') {
						this.set({ newCatalogueItem: { name: null, price: null } })
						this.set({catalogue: [...catalogue, {name, price: parsedPrice}]});
						console.debug("updated catalogue")
						console.table(catalogue)
					} else {
						console.error("not valid")
					}
				} catch (error) {
					console.error("no valid price", {error})
				}
            },
            resetAll() {
                this.set({
                    selectedTap: null,
                    newTapName: null,
                    taps: {}
                })
            }
        },

        computed: {
        }
    }
</script>